<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel de Pedidos ‚Äî A√ßaiteria Tropical</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --green: #8507ce;
      --green-dark: #27ae60;
      --blue: #3498db;
      --bg1: #f8fdf8;
      --bg2: #eafaf1;
      --text: #2d3142;
      --muted: #6b7280;
      --card: #ffffff;
      --shadow: 0 6px 16px rgba(0,0,0,0.08);
      --radius: 14px;
      --orange: #e67e22;
      --red: #e74c3c;
    }
    body { font-family: "Inter", sans-serif; background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: var(--text); margin: 0; }
    header.topbar { position: sticky; top: 0; z-index: 50; background: linear-gradient(90deg, var(--green-dark), var(--green)); color: #fff; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .topbar h1 { margin: 0; font-size: 22px; display: flex; align-items: center; gap: 10px; font-weight: 800; }
    
    .actions button { border: none; border-radius: 10px; padding: 10px 14px; font-weight: 800; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: var(--shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .actions button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,0.15) }
    #toggleSom { background: var(--green); color: #fff }
    #toggleSom.active { background: var(--orange); }
    #apagarTudo { background: var(--red); color: #fff }
    #gerarPDF   { background: var(--blue); color: #fff }

    main { padding: 20px }
    .dashboard { max-width: 980px; margin: 0 auto 20px; display: flex; gap: 16px; flex-wrap: wrap; }
    .dash-card { flex: 1; min-width: 220px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; text-align: center; }
    .dash-card h3 { margin: 0; font-size: 15px; color: var(--muted); font-weight: 700; }
    .dash-card p { margin: 6px 0 0; font-size: 22px; font-weight: 800; color: var(--green-dark); }

    .pedidos { display: grid; gap: 16px; max-width: 980px; margin: 0 auto; }
    .pedido-wrapper { display: flex; align-items: flex-start; gap: 12px; }
    .pedido { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; flex: 1; border-left: 6px solid var(--green); }
    .pedido.blue { border-left-color: var(--blue); }

    .pedido-ok { font-size: 48px; color: var(--green-dark); flex-shrink: 0; display: none; align-self: center; }
    .pedido-ok.active { display: block; }

    .pedido-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .pedido-header h3 { margin: 0; font-size: 20px; color: var(--green-dark); display: flex; align-items: center; gap: 8px; }
    .pedido-header .valor { background: #ebfff3; color: #0f5132; border: 2px solid #d1f7df; border-radius: 999px; padding: 6px 12px; font-weight: 800; }
    .pedido p { margin: 4px 0; display: flex; align-items: center; gap: 6px; }
    .pedido details { margin-top: 10px; background: #f7faf7; border: 1px solid #e4eee4; border-radius: 10px; padding: 10px; }
    .pedido details summary { cursor: pointer; font-weight: 800; color: #374151; display: flex; align-items: center; gap: 8px; }
    .pedido hr { border: none; border-top: 1px dashed #e5e7eb; margin: 8px 0 }
    .pedido small { display: block; margin-top: 10px; color: var(--muted); font-size: 12px; display: flex; align-items: center; gap: 6px; }

    .pedido .actions-row { margin-top: 12px; display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .pedido .wa-btn { background: #25d366; color: #fff; padding: 6px 12px; border-radius: 8px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .pedido .wa-btn.secondary { background: #128C7E; }
    .pedido .wa-btn:hover { filter: brightness(0.95); }
  </style>
</head>
<body>

  <header class="topbar">
    <h1><img style="width: 150px; border-radius: 10px;" src="acaizap.jpg" alt=""> Painel de Pedidos</h1>
    <div class="actions">
      <button id="toggleSom"><i class="fas fa-volume-up"></i> Ativar som</button>
      <button id="apagarTudo"><i class="fas fa-trash"></i> Apagar todos</button>
      <button id="gerarPDF"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
    </div>
  </header>

  <main>
    <div class="dashboard">
      <div class="dash-card"><h3>Pedidos hoje</h3><p id="statHoje">0</p></div>
      <div class="dash-card"><h3>Total do dia</h3><p id="statTotal">R$ 0,00</p></div>
    </div>

    <div id="pedidos" class="pedidos">Carregando pedidos...</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "acai123-4ad1a.firebaseapp.com",
      projectId: "acai123-4ad1a",
      storageBucket: "acai123-4ad1a.firebasestorage.app",
      messagingSenderId: "423472519123",
      appId: "1:423472519123:web:b8795b57e347f473d7c126",
      measurementId: "G-K86FBM1JE5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pedidosRef = query(collection(db, "pedidos"), orderBy("data", "desc"));
    const lista = document.getElementById("pedidos");

    // Utils
    const formatBRL = (n) => Number(n || 0).toLocaleString('pt-BR',{minimumFractionDigits:2});
    const onlyDigits = (s) => String(s||'').replace(/\D+/g,'');
    const waLink = (tel, msg) => `https://wa.me/55${onlyDigits(tel)}?text=${encodeURIComponent(msg)}`;

    // Persist√™ncia do OK (saiu para entrega)
    let okEntregas = {};
    try { okEntregas = JSON.parse(localStorage.getItem("okEntregas") || "{}"); } catch { okEntregas = {}; }
    const setOkEntrega = (id, val) => {
      okEntregas[id] = !!val;
      localStorage.setItem("okEntregas", JSON.stringify(okEntregas));
    };

    // Som (toggle)
    let ctx = null;
    let soundEnabled = false;
    async function ensureAudio() {
      if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (ctx.state === "suspended") await ctx.resume();
    }
    async function bip() {
      if (!soundEnabled) return;
      await ensureAudio();
      const beep = (t) => {
        const osc = ctx.createOscillator(), gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = "square"; osc.frequency.value = 1200;
        gain.gain.setValueAtTime(1, ctx.currentTime + t);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.3);
        osc.start(ctx.currentTime + t); osc.stop(ctx.currentTime + t + 0.3);
      };
      beep(0); beep(0.5); beep(1.0);
    }
    const btnSom = document.getElementById("toggleSom");
    btnSom.addEventListener("click", async () => {
      if (!soundEnabled) {
        await ensureAudio();
        soundEnabled = true;
        btnSom.classList.add("active");
        btnSom.innerHTML = '<i class="fas fa-volume-mute"></i> Desativar som';
        Swal.fire("Som ativado!", "Novos pedidos v√£o bipar.", "success");
      } else {
        soundEnabled = false;
        btnSom.classList.remove("active");
        btnSom.innerHTML = '<i class="fas fa-volume-up"></i> Ativar som';
        Swal.fire("Som desativado!", "Os pedidos n√£o v√£o bipar.", "info");
      }
    });

    // Render do card + √≠cone externo persistente
    function renderPedidoWrapper(pedido, indexFromTop) {
      const wrapper = document.createElement("div");
      wrapper.className = "pedido-wrapper";

      const card = document.createElement("div");
      card.className = indexFromTop >= 1 ? "pedido blue" : "pedido";

      const okIcon = document.createElement("div");
      okIcon.className = "pedido-ok";
      okIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
      if (okEntregas[pedido.id]) okIcon.classList.add("active");

      const totalBRL = formatBRL(pedido.total);
      const taxa = pedido.taxaEntrega ? ` (+ taxa R$ ${formatBRL(pedido.taxaEntrega)})` : "";
      const dt = pedido.data ? new Date(pedido.data).toLocaleString("pt-BR") : "-";

      const itensHTML = Array.isArray(pedido.itens) ? pedido.itens.map((i,idx)=>`
        <div class="item">
          <strong>#${idx+1}</strong> ‚Äî ${i.tipo || 'Item'} ${i.size?i.size+'ml':''}
          (R$ ${formatBRL(i.price)})
          ${i.fruits?.length ? `<br>üçì Frutas: ${i.fruits.join(", ")}` : ""}
          ${i.ingredients?.length ? `<br>ü•ú Ingredientes: ${i.ingredients.join(", ")}` : ""}
          ${i.topping ? `<br>üç´ Cobertura: ${i.topping}` : ""}
          ${i.extras?.length ? `<br>‚≠ê Adicionais: ${i.extras.join(", ")}` : ""}
          ${i.drinks?.length ? `<br>ü•§ Bebidas: ${i.drinks.map(d => `${d.label} (${Number(d.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})})`).join(", ")}` : ""}
          ${i.notes ? `<br>üìù Obs: ${i.notes}` : ""}
        </div>
        <hr>
      `).join("") : "<div class='item'>Sem itens</div>";

      const msgConfirm = `Ol√° ${pedido.cliente||''}! Confirmando seu pedido de R$ ${totalBRL}.`;
      const msgSaiu = `Seu pedido j√° saiu para entrega... Obrigado e volte sempre!`;

      card.innerHTML = `
        <div class="pedido-header">
          <h3><i class="fas fa-user"></i> ${pedido.cliente || "-"}</h3>
          <span class="valor">R$ ${totalBRL}</span>
        </div>

        <p><i class="fas fa-phone"></i> ${pedido.telefone || "-"}</p>
        <p><i class="fas fa-map-marker-alt"></i> ${pedido.endereco || "-"}${pedido.bairro ? ', ' + pedido.bairro : ''}</p>
        <p><i class="fas fa-credit-card"></i> ${pedido.pagamento || "-"}</p>

        <details>
          <summary><i class="fas fa-box"></i> Itens</summary>
          ${itensHTML}
        </details>

        ${pedido.observacoes ? `<p><strong>Obs. gerais:</strong> ${pedido.observacoes}</p>` : ""}

        <small><i class="fas fa-clock"></i> Recebido em: ${dt}</small>
        ${taxa ? `<small><i class="fas fa-truck"></i> Taxa: ${taxa}</small>` : ""}

        <div class="actions-row">
          <a class="wa-btn" target="_blank" rel="noopener noreferrer"
             href="${waLink(pedido.telefone, msgConfirm)}">
             <i class="fab fa-whatsapp"></i> Confirmar pedido
          </a>

          <button class="wa-btn secondary saiu-btn" data-id="${pedido.id}" data-tel="${onlyDigits(pedido.telefone || '')}">
            <i class="fab fa-whatsapp"></i> Saiu para entrega
          </button>
        </div>
      `;

      // Handler do bot√£o "Saiu para entrega"
      const btnSaiu = card.querySelector(".saiu-btn");
      btnSaiu.addEventListener("click", () => {
        const tel = btnSaiu.getAttribute("data-tel");
        const id = btnSaiu.getAttribute("data-id");
        const url = `https://wa.me/55${tel}?text=${encodeURIComponent(msgSaiu)}`;
        window.open(url, "_blank", "noopener,noreferrer");

        okIcon.classList.add("active");
        setOkEntrega(id, true); // persiste o OK no localStorage
      });

      wrapper.appendChild(card);
      wrapper.appendChild(okIcon);
      return wrapper;
    }

    // Dashboard (dia: quantidade e total)
    const elHoje   = document.getElementById("statHoje");
    const elTotal  = document.getElementById("statTotal");
    function updateDashboard(pedidos) {
      const now = new Date();
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      let countHoje = 0;
      let totalHoje = 0;
      pedidos.forEach(p => {
        const ts = p.data ? new Date(p.data).getTime() : 0;
        if (ts >= startOfToday) {
          countHoje++;
          totalHoje += Number(p.total || 0);
        }
      });
      elHoje.textContent  = String(countHoje);
      elTotal.textContent = `R$ ${totalHoje.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
    }

    // Tempo real + bip para novos
    let firstLoadDone = false;
    let knownIds = new Set();
    onSnapshot(pedidosRef, (snapshot) => {
      lista.innerHTML = "";
      if (snapshot.empty) {
        lista.innerHTML = "<p>Nenhum pedido.</p>";
        updateDashboard([]);
        knownIds.clear();
        return;
      }

      const pedidos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      pedidos.forEach((p, idx) => {
        const wrapper = renderPedidoWrapper(p, idx);
        lista.appendChild(wrapper);
      });

      if (firstLoadDone) {
        const hasNew = pedidos.some(p => !knownIds.has(p.id));
        if (hasNew) bip();
      }
      knownIds = new Set(pedidos.map(p => p.id));
      updateDashboard(pedidos);
      firstLoadDone = true;
    });

    // Apagar todos os pedidos + limpar √≠cones OK persistidos
    document.getElementById("apagarTudo").addEventListener("click", async () => {
      const confirm = await Swal.fire({
        title: 'Apagar todos os pedidos?',
        text: 'Essa a√ß√£o n√£o pode ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sim, apagar',
        cancelButtonText: 'Cancelar'
      });
      if (!confirm.isConfirmed) return;

      const snap = await getDocs(collection(db, "pedidos"));
      let erros = 0;
      for (const d of snap.docs) {
        try { await deleteDoc(doc(db, "pedidos", d.id)); }
        catch { erros++; }
      }

      // Limpa persist√™ncia dos OK
      localStorage.removeItem("okEntregas");
      okEntregas = {};

      if (erros === 0) {
        await Swal.fire({ icon: 'success', title: 'Pronto!', text: 'Todos os pedidos foram apagados.' });
      } else {
        await Swal.fire({ icon: 'error', title: 'Algo falhou', text: `N√£o foi poss√≠vel apagar ${erros} registro(s).` });
      }
    });

    // PDF (resumo simples)
    document.getElementById("gerarPDF").addEventListener("click", async () => {
      const snap = await getDocs(query(collection(db, "pedidos"), orderBy("data", "desc")));
      if (snap.empty) {
        await Swal.fire({ icon: 'info', title: 'Sem pedidos', text: 'Nenhum pedido para gerar balan√ßo.' });
        return;
      }
      const pedidos = snap.docs.map(d => d.data());
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });

      const drawHeader = (yHeader = 15) => {
        pdf.setFontSize(16);
        pdf.text('Balan√ßo de Pedidos ‚Äî A√ßaiteria Tropical', 10, yHeader);
        pdf.setFontSize(11);
        pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 10, yHeader + 7);
        const yTableHeader = yHeader + 15;
        pdf.setFontSize(10);
        pdf.setFillColor(235, 245, 238);
        pdf.rect(8, yTableHeader - 5, 194, 8, 'F');
        pdf.text('#', 10, yTableHeader);
        pdf.text('Cliente', 20, yTableHeader);
        pdf.text('Telefone', 70, yTableHeader);
        pdf.text('Bairro', 100, yTableHeader);
        pdf.text('Total (R$)', 180, yTableHeader);
        return yTableHeader + 6;
      };

      let y = drawHeader();
      let totalGeral = 0;
      pedidos.forEach((p, idx) => {
        pdf.setDrawColor(230, 230, 230);
        pdf.line(8, y - 3, 202, y - 3);
        pdf.text(String(idx + 1), 10, y);
        pdf.text(p.cliente || '-', 20, y);
        pdf.text(p.telefone || '-', 70, y);
        pdf.text(p.bairro || '-', 100, y);
        const total = Number(p.total || 0);
        totalGeral += total;
        pdf.text(total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }), 180, y);
        y += 6;
        if (y > 270) { pdf.addPage(); y = drawHeader(15); }
      });

      if (y > 260) { pdf.addPage(); y = drawHeader(15); }
      pdf.setFontSize(12);
      pdf.text(`TOTAL GERAL: R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, 10, y + 10);
      pdf.setFontSize(9);
      pdf.text('A√ßaiteria Tropical ‚Äî Painel de Pedidos', 10, 290);

      pdf.save('balanco-pedidos.pdf');
    });

    // Bloqueios de seguran√ßa
  document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) { e.preventDefault(); }
    if (e.key === 'F12') { e.preventDefault(); }
  });
  document.addEventListener('keydown', function (event) {
    if (event.ctrlKey && event.shiftKey && event.key === 'I') { event.preventDefault(); }
  });
  document.addEventListener('contextmenu', function (event) { event.preventDefault(); });
  </script>
</body>
</html>
